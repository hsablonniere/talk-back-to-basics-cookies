= #RetourAuxSources : Les Cookies HTTP
Hubert Sablonnière
:author-twitter: @hsablonniere
:author-avatar: img/hsablonniere-profil-2017.jpg
:author-company: Clever Cloud
:author-company-logo: img/clever-cloud-logo.svg
:hashtags: #CookiesRocks
:event: BreizhCamp
:date: 30 mars 2018

[slide=poster]
Intro

[WARNING, caption=Avertissement]
Cette présentation n'aborde aucune technologie à la mode.
Le sujet se concentre sur un vieux truc inventé dans les années 90 (que vous connaissez peut-être déjà).
[.question]#Acceptez-vous de poursuivre la présentation ?#
Si vous voulez savoir comment déployer dans la blockchain des microservices Kotlin avec Kubernetes, il est encore temps de changer de salle...

[slide=location]
&nbsp;

[slide=location]
Il y a quelques mois...
221b Baker Street
Londres

[quote, Watson]
I'm almost there...

J'arrive, j'arrive...

[quote, Watson]
What's up Sherlock?

Que se passe t-il Sherlock ?

[quote, Sherlock]
I'm confused by bloody developers!

[quote, Sherlock]
Such fashion victims!

[quote, Watson]
It seems logical, isn't&nbsp;it?

[quote, Sherlock]
They're missing the great investigation!

[quote, Watson]
Which one?

[quote, Sherlock]
HTTP cookies of&nbsp;course!

[quote, Sherlock]
I asked Hubert to investigate...

[quote, Watson]
The fucking froggy?

[quote, Sherlock]
Yes but he's a&nbsp;redhead.

[quote, Sherlock]
Facts, facts, facts!

[quote, Watson]
Interesting...

[slide=poster]
Bonjour à tous

#mode normal (et énergique)# +
Bonjour à *toutes* et tous ! +
J'm'appelle Hubert Sablonnière, +
J'suis développeur Web chez #Clever Cloud#.

.Clever Cloud
image::img/cc-rocket-man.png[role=logo]

Qui connait Clever Cloud ?

[source, js, slide=code]
if (true) {
  toi.passerAuStand('Clever Cloud');
}

[slide=blank]
Enchaînement vers cookies

image::img/2018-1994.svg[role="contain"]

// http://facesofopensource.com/lou-montulli/
// http://www.peteradamsphoto.com/lou-montulli-2/
image::img/loumontulli.jpg[author="Peter Adams", role="big top"]

.Netscape
image::img/netscape_4-6.svg[role=logo]

[slide=text]
fishcam : des poissons en live depuis 1994

[slide=text]
Lynx : navigateur mode texte

image::img/screenshots/wikipedia-lynx.jpg[url="https://en.wikipedia.org/wiki/Lynx_(web_browser)"]

[slide=text]
[.blink]`<blink>` : la meilleure balise de tous les temps !

[slide=text]
[.shake]`<shake>` : si on m'avait demandé mon avis...

[slide=text]
gifs animés : parceque Java c'est trop long à charger

video::videos/no.mp4[role=contain]

image::img/loumontulli.jpg[author="Peter Adams", role="contain light"]

== Point de vue n°1 : celui/celle qui veut sécuriser son site Web

[slide=question]
C'est quoi un cookie HTTP ?

image::img/cookies-flow-01.svg[role=contain]

image::img/cookies-flow-02.svg[role=contain]

image::img/cookies-flow-03.svg[role=contain]

image::img/cookies-flow-04.svg[role=contain]

image::img/cookies-flow-05.svg[role=contain]

image::img/cookies-flow-06.svg[role=contain]

image::img/cookies-flow-07.svg[role=contain]

image::img/cookies-flow-08.svg[role=contain]

image::img/cookies-flow-09.svg[role=contain]

image::img/cookies-flow-10.svg[role=contain]

image::img/cookies-flow-11.svg[role=contain]

image::img/cookies-flow-12.svg[role=contain]

[slide=blank]
Démo d'un cookie simple dans le browser

image::img/rfcs-01.svg[role=contain]

image::img/rfcs-02.svg[role=contain]

image::img/rfcs-03.svg[role=contain]

[slide=question]
Combien de temps  est stocké un cookie ?

.Expirer à la fermeture de la session
[source, cookies]
Set-Cookie: name=value

.Expirer à une date
[source, cookies]
Set-Cookie: name=value;
            Expires=Wed, 20 Jan 2021 10:30:00 GMT

.Expirer dans 24h
[source, cookies]
Set-Cookie: name=value; Max-Age=86400

[slide=blank]
Démo de cookie persistent

[slide=question]
Comment le serveur  supprime un cookie ?

.Supprimer un cookie
[source, cookies]
Set-Cookie: name=value;
            Expires=Thu, 01 Jan 1970 00:00:00 GMT

.Supprimer un cookie
[source, cookies]
Set-Cookie: name=value; Max-Age=0

[slide=blank]
Démo suppression de cookie

[slide=question]
Quand est-ce que  les cookies sont  envoyés automatiquement ?

[source, cookies]
Set-Cookie: name=value

[source, cookies]
Set-Cookie: name=value; Domain=cookies.rocks

[source, cookies]
Set-Cookie: name=value; Domain=blue.cookies.rocks

[source, cookies]
Set-Cookie: name=value; Domain=big.blue.cookies.rocks

[slide=blank]
Démos de cookies avec l'attribut Domain

[slide=question]
Un cookie pour `.com` ?

video::videos/no.mp4#t=4[role=contain]

image::img/screenshots/mozilla-issue-252342.jpg[url="https://bugzilla.mozilla.org/show_bug.cgi?id=252342"]

image::img/screenshots/mozilla-issue-331510.jpg[url="https://bugzilla.mozilla.org/show_bug.cgi?id=331510"]

image::img/screenshots/mozilla-issue-342314.jpg[url="https://bugzilla.mozilla.org/show_bug.cgi?id=342314"]

image::img/screenshots/mozilla-public-suffix-list.jpg[url="https://wiki.mozilla.org/Public_Suffix_List"]

image::img/screenshots/publicsuffix-org.jpg[url="https://publicsuffix.org"]

image::img/rfcs-04.svg[role=contain]

image::img/screenshots/rfc6265-page23.jpg[url="https://tools.ietf.org/html/rfc6265#page-23", width="1024"]

image::img/screenshots/mozilla-source-effective-tld-names.jpg[url="https://dxr.mozilla.org/mozilla-central/source/netwerk/dns/effective_tld_names.dat", width="1024"]

image::img/screenshots/chrome-source-effective-tld-names.jpg[url="https://chromium.googlesource.com/chromium/src/net/+/master/base/registry_controlled_domains/effective_tld_names.dat"]

image::img/screenshots/safari-source-effective-tld-names.jpg[url="https://github.com/WebKit/webkit/blob/master/Source/WebCore/platform/soup/PublicSuffixSoup.cpp"]

image::img/screenshots/libsoup-source-effective-tld-names.jpg[url="https://github.com/GNOME/libsoup/blob/master/data/effective_tld_names.dat"]

.Public Suffix List (extrait)
[source, ini, slide=code]
----
// GitHub, Inc.
// Submitted by Patrick Toomey <security@github.com>
github.io
githubusercontent.com

// GitLab, Inc.
// Submitted by Alex Hanselka <alex@gitlab.com>
gitlab.io
----

[slide=question]
Un cookie pour `.localhost` ?

video::videos/no.mp4#t=7[role=contain]

[slide=blank]
Pause gif

[source, cookies]
Set-Cookie: name=value; Path=/api

[slide=blank]
Démos de cookies avec l'attribut path

[source, cookies]
Set-Cookie: name=value; Secure

[slide=blank]
Démos de cookies avec l'attribut secure

image::img/screenshots/draft-ietf-httpbis-cookie-alone.jpg[url="https://tools.ietf.org/html/draft-ietf-httpbis-cookie-alone-01", width="1024"]

.Header HSTS (attention !)
[source, http, slide=code]
Strict-Transport-Security: max-age=86400;
                           includeSubDomains

[slide=question]
Y a-t-il une  vérification sur le port ?

video::videos/no.mp4#t=13[role=contain]

[slide=text]
SOP : Same Origin Policy

image::img/origin.svg[role=contain]

image::img/screenshots/draft-west-origin-cookies.jpg[url="https://tools.ietf.org/html/draft-west-origin-cookies-01", width="1024"]

[slide=text]
AJAX : Asynchronous JavaScript & XML

[source, js, slide=code]
----
const xhr = new XMLHttpRequest();
xhr.open('GET', '/url', true);
xhr.responseType = 'json';

xhr.withCredentials = true;

xhr.send();
----

[source, http, slide=code]
Access-Control-Allow-Credentials: true

[slide=text]
fetch : La nouvelle XHR

[source, js, slide=code]
fetch('/url', { credentials: 'omit' })
fetch('/url', { credentials: 'same-origin' })
fetch('/url', { credentials: 'include' })

image::img/screenshots/caniuse-fetch.jpg[url="https://caniuse.com/#feat=fetch"]

image::img/cookies-flow-08.svg[role=contain]

image::img/cookies-flow-09.svg[role=contain]

image::img/cookies-flow-10.svg[role=contain]

image::img/cookies-flow-11.svg[role=contain]

[slide=question]
C'est quoi  une attaque CSRF/XSRF ?

[slide=blank]
Démos CSRF

image::img/screenshots/owasp-csrf.jpg[url="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)"]

image::img/rfcs-05.svg[role=contain]

[source, cookies]
Set-Cookie: name=value; SameSite=Lax

[source, cookies]
Set-Cookie: name=value; SameSite=Strict

[slide=blank]
Démos samesite

// [#screenshot-caniuse-samesite-cookies.contain]
// image::img/screenshots/caniuse-com-feat-same-site-cookie-attribute.jpg[]

[slide=question]
Qui peut lire quels cookies ?

[slide=text]
`document.cookie` : l'API navigateur la plus étrange du monde

[slide=blank]
Démo document.cookie

[slide=question]
C'est quoi  une attaque XSS ?

image::img/screenshots/owasp-xss.jpg[url="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)"]

image::img/screenshots/developers-google-csp.jpg[url="https://developers.google.com/web/fundamentals/security/csp/"]

[source, cookies]
Set-Cookie: name=value; HttpOnly

[slide=blank]
Démo http only

image::img/rfcs-05.svg[role=contain]

[source, cookies]
Set-Cookie: __Secure-name=value; Secure

[source, cookies]
Set-Cookie: __Host-name=value; Secure; Path=/

.Récap. des attributs
[source, cookies]
Set-Cookie: name=value;
            Expires=Tue, 03 Nov 2020 00:00:00 GMT;
            Max-Age=86400;
            Domain=one.cookies.rocks;
            Path=/api;
            Secure;
            HttpOnly;
            SameSite=Lax;
            SameSite=Strict

[slide=question]
Quelles alternatives  pour un stockage local ?

[slide=text]
`window.name` : la vieille technique cross-site

[slide=blank]
Démo window.name

[slide=text]
Web Storage : `localStorage` et `sessionStorage`

[slide=blank]
Démo Web Storage

[slide=question]
Que dit la CNIL ?

image::img/screenshots/cnil-cookies-conformite.jpg[url="https://www.cnil.fr/fr/cookies-comment-mettre-mon-site-web-en-conformite"]

image::img/screenshots/cnil-cookies-la-loi.jpg[url="https://www.cnil.fr/fr/cookies-traceurs-que-dit-la-loi"]

== Point de vue n°2 : celui/celle qui veut "tracer" ses visiteurs

// rappel conditions du CSRF

[slide=blank]
Démo tracking cookie tiers avec referer

[slide=question]
C'est quoi le referer ?

image::img/screenshots/caniuse-referer.jpg[url="https://caniuse.com/#search=referer"]

image::img/screenshots/w3c-referrer-policy.jpg[url="https://www.w3.org/TR/referrer-policy/"]

[slide=question]
C'est quoi un supercookie ?

[slide=text]
Traçage sans JavaScript : ETag, Date, HSTS Pinning, 301 Redirect...
// redirect ?

[slide=blank]
Démo tracking etag avec referer

[slide=text]
Traçage avec JavaScript : Cache, Web Storage, IndexedDB, window.name, Canvas...

[slide=text]
Traçage avec JavaScript : (CSS :visited)...

[slide=text]
Traçage JavaScript : (Flash, Silverlight)...

image::img/screenshots/evercookie.jpg[url="https://github.com/samyk/evercookie"]

image::img/screenshots/evercookie-browser-storage-mechanisms.jpg[url="https://github.com/samyk/evercookie#browser-storage-mechanisms"]

== Point de vue n°3 : celui/celle qui est soucieux de sa vie privée

[slide=question]
Comment régler  mon navigateur ?

[slide=text]
Les cookies tiers

[slide=blank]
Démo du réglage des cookies tiers

[slide=text]
L'en-tête `referer`

[slide=blank]
Démo du réglage des referers

[slide=question]
Ils sont où les cookies ?

[slide=blank]
Démo du fichier contenant les cookies

[slide=question]
Faut-il installer des  extensions navigateur  en plus ?

image::img/screenshots/https-everywhere.jpg[url="https://www.eff.org/fr/https-everywhere"]

//uBlock

image::img/screenshots/adblockplus.jpg[url="https://adblockplus.org/fr/"]

image::img/screenshots/ghostery.jpg[url="https://www.ghostery.com/fr/"]

image::img/screenshots/addons-mozilla-firefox-container.jpg[url="https://addons.mozilla.org/en-US/firefox/addon/facebook-container/"]

image::img/screenshots/disconnect-me.jpg[url="https://disconnect.me/"]

image::img/screenshots/privacybadger.jpg[url="https://www.eff.org/fr/privacybadger"]

image::img/screenshots/noscript.jpg[url="https://noscript.net/"]

image::img/screenshots/panopticlick.jpg[url="https://panopticlick.eff.org/about"]

image::img/screenshots/torbrowser.jpg[url="https://www.torproject.org/projects/torbrowser.html.en"]

[slide=question]
Que fait la navigation privée  dans tout ça ?

[slide=question]
WiFi gratuits ?

// [slide=question]
// La CNIL est mon amie

image::img/1994-2018.svg[role=contain]

// https://web.archive.org/web/20130912000824/http://www.montulli-blog.com:80/2013/05/why-blocking-3rd-party-cookies-could-be.html
// Lou
// The answer is pretty simple:
//
// [#quote]
// The evil you know is better than the one you don't.
// This is probably a race we can't win.

[slide=blank]
Histoire d'outro avec Sherlock

[quote, Sherlock]
Wow&nbsp;lots&nbsp;of facts&nbsp;here!

[quote, Watson]
Indeed

[quote, Sherlock]
Know when it smells...

[quote, Sherlock]
Spread knowledge...

[quote, Sherlock]
Debate&nbsp;the&nbsp;future of&nbsp;the Web!

.Merci bcp !
[slide=poster]
Outro

[slide=question]
Des questions ?
